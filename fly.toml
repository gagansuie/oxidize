# Oxidize Relay Server - Fly.io Configuration
# Deploy with: fly deploy
# Scale regions: fly scale count 3 --region iad,ord,lax

app = "oxidize-relay"
primary_region = "ord"

[build]
  dockerfile = "Dockerfile.server"

[env]
  RUST_LOG = "info"
  RUST_BACKTRACE = "1"

[http_service]
  internal_port = 9090
  force_https = false
  auto_stop_machines = false
  auto_start_machines = true
  min_machines_running = 1

  [http_service.concurrency]
    type = "requests"
    hard_limit = 250
    soft_limit = 200

# QUIC/UDP service on port 4433
[[services]]
  protocol = "udp"
  internal_port = 4433

  [[services.ports]]
    port = 4433

# Prometheus metrics (internal)
[[services]]
  protocol = "tcp"
  internal_port = 9090

  [[services.ports]]
    port = 9090
    handlers = ["http"]

[checks]
  [checks.health]
    port = 9090
    type = "http"
    interval = "15s"
    timeout = "5s"
    path = "/health"

[[vm]]
  size = "shared-cpu-2x"
  memory = "1gb"
  cpus = 2

# Recommended regions for US coverage:
# iad - Ashburn (East Coast)
# ord - Chicago (Central) - PRIMARY
# lax - Los Angeles (West Coast) - REQUIRED for CA users
# dfw - Dallas (South)
# sea - Seattle (Northwest)
#
# Deploy to multiple regions:
#   fly scale count 3 --region ord,lax,iad
#
# Networking:
#   - Dedicated IPv4 RECOMMENDED for UDP/QUIC ($2/month)
#   - Flycast IPv6 NOT needed (for private inter-app only)
