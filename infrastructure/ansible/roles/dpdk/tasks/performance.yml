---
- name: Determine total CPU cores
  set_fact:
    total_cores: "{{ ansible_processor_vcpus | default(ansible_processor_count * ansible_processor_cores) | int }}"

- name: Compute isolated cores list
  set_fact:
    isolated_cores: "{{ (total_cores | int > 2) | ternary('2-' ~ (total_cores | int - 1), (total_cores | int > 1) | ternary('1-' ~ (total_cores | int - 1), '')) }}"
  when: total_cores | int > 0

- name: Read current GRUB_CMDLINE_LINUX_DEFAULT
  shell: "grep '^GRUB_CMDLINE_LINUX_DEFAULT=' /etc/default/grub | cut -d'=' -f2- | sed 's/^\"//;s/\"$//'"
  register: grub_cmdline_default
  changed_when: false
  become: yes
  ignore_errors: yes

- name: Build updated GRUB cmdline with CPU isolation
  set_fact:
    grub_cmdline_base: "{{ (grub_cmdline_default.stdout | default('quiet splash')) | trim }}"
    grub_cmdline_updated: "{{ grub_cmdline_base ~ ( ' isolcpus=' ~ isolated_cores if isolated_cores | length > 0 and ('isolcpus=' not in grub_cmdline_base) else '' ) ~ ( ' nohz_full=' ~ isolated_cores if isolated_cores | length > 0 and ('nohz_full=' not in grub_cmdline_base) else '' ) ~ ( ' rcu_nocbs=' ~ isolated_cores if isolated_cores | length > 0 and ('rcu_nocbs=' not in grub_cmdline_base) else '' ) }}"
  when: isolated_cores is defined

- name: Update GRUB for CPU isolation
  lineinfile:
    path: /etc/default/grub
    regexp: '^GRUB_CMDLINE_LINUX_DEFAULT='
    line: 'GRUB_CMDLINE_LINUX_DEFAULT="{{ grub_cmdline_updated | trim }}"'
    backup: yes
  become: yes
  when:
    - isolated_cores is defined
    - isolated_cores | length > 0
    - grub_cmdline_updated is defined
    - grub_cmdline_updated != grub_cmdline_base
  register: grub_isolation_updated

- name: Update GRUB after CPU isolation change
  command: update-grub
  become: yes
  when: grub_isolation_updated.changed | default(false)

- name: Mark reboot required for CPU isolation
  set_fact:
    reboot_required: true
  when: grub_isolation_updated.changed | default(false)

- name: Disable irqbalance
  service:
    name: irqbalance
    state: stopped
    enabled: no
  become: yes
  ignore_errors: yes

- name: Set CPU governor to performance via cpufrequtils
  command: cpufreq-set -r -g performance
  become: yes
  ignore_errors: yes

- name: Persist CPU governor
  copy:
    dest: /etc/default/cpufrequtils
    content: 'GOVERNOR="performance"\n'
  become: yes

- name: Force performance governor via sysfs
  shell: "for gov in /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor; do echo performance > \"$gov\" 2>/dev/null || true; done"
  become: yes
  changed_when: false

- name: Disable CPU C-states
  shell: "for state in /sys/devices/system/cpu/cpu*/cpuidle/state*/disable; do echo 1 > \"$state\" 2>/dev/null || true; done"
  become: yes
  changed_when: false
