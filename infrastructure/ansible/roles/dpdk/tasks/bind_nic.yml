---
- name: Get management NIC (default route)
  shell: ip route | grep default | awk '{print $5}' | head -1
  register: mgmt_nic
  changed_when: false

- name: Get all network interfaces
  shell: ls /sys/class/net | grep -v lo | grep -v "{{ mgmt_nic.stdout }}"
  register: all_nics
  changed_when: false

- name: Set data NIC (first non-management NIC)
  set_fact:
    data_nic: "{{ all_nics.stdout_lines[0] | default('') }}"
  when: all_nics.stdout_lines | length > 0

- name: Get PCI address of data NIC
  shell: "ethtool -i {{ data_nic }} | grep bus-info | awk '{print $2}'"
  register: data_pci
  when: data_nic is defined and data_nic != ""
  changed_when: false

- name: Check if NIC already bound to DPDK
  shell: "dpdk-devbind.py --status-dev net | grep '{{ data_pci.stdout }}' | grep -E 'vfio-pci|igb_uio' || true"
  register: nic_bound
  when: data_pci.stdout is defined
  changed_when: false

- name: Bring down data NIC
  command: "ip link set {{ data_nic }} down"
  become: yes
  when:
    - data_nic is defined
    - data_nic != ""
    - nic_bound.stdout == ""
  ignore_errors: yes

- name: Bind data NIC to vfio-pci
  command: "dpdk-devbind.py --bind=vfio-pci {{ data_pci.stdout }}"
  become: yes
  when:
    - data_pci.stdout is defined
    - nic_bound.stdout == ""
  register: bind_result
  ignore_errors: yes

- name: Fallback to uio_pci_generic if vfio-pci fails
  block:
    - name: Load uio_pci_generic module
      modprobe:
        name: uio_pci_generic
        state: present
      become: yes

    - name: Bind to uio_pci_generic
      command: "dpdk-devbind.py --bind=uio_pci_generic {{ data_pci.stdout }}"
      become: yes
  when:
    - bind_result.rc is defined
    - bind_result.rc != 0

- name: Save NIC configuration
  copy:
    content: |
      MGMT_NIC={{ mgmt_nic.stdout }}
      DATA_NIC={{ data_nic | default('') }}
      DATA_PCI={{ data_pci.stdout | default('') }}
      DPDK_MODE=true
    dest: /etc/oxidize/nic-config.env
  become: yes
  when: data_pci.stdout is defined

- name: Display NIC configuration
  debug:
    msg: |
      Management NIC: {{ mgmt_nic.stdout }}
      Data NIC: {{ data_nic | default('none') }}
      Data PCI: {{ data_pci.stdout | default('none') }}
