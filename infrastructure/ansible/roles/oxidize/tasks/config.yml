---
- name: Check if config exists
  stat:
    path: /etc/oxidize/server.toml
  register: config_exists

- name: Get public IP for config
  uri:
    url: https://ifconfig.me
    return_content: yes
    timeout: 10
  register: public_ip
  when: not config_exists.stat.exists

- name: Detect data NIC for XDP
  shell: ip route get 8.8.8.8 | grep -oP 'dev \K\S+' | head -1
  register: data_nic
  changed_when: false
  when: not config_exists.stat.exists

- name: Get CPU count
  command: nproc
  register: cpu_count
  changed_when: false

- name: Get hugepages count
  slurp:
    src: /proc/sys/vm/nr_hugepages
  register: hugepages_raw
  ignore_errors: yes

- name: Set hugepages fact
  set_fact:
    hugepages_count: "{{ hugepages_raw.content | b64decode | trim | default('0') }}"
  when: hugepages_raw.content is defined

- name: Generate server configuration
  template:
    src: server.toml.j2
    dest: /etc/oxidize/server.toml
    mode: '0644'
  become: yes
  when: not config_exists.stat.exists

- name: Deploy authentication secrets
  template:
    src: auth.env.j2
    dest: /etc/oxidize/auth.env
    mode: '0600'
    owner: root
    group: root
  become: yes
  when: oxidize_app_public_key is defined and oxidize_api_secret is defined
  notify: restart oxidize
