name: Release Build

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  SCCACHE_GHA_ENABLED: "true"
  SCCACHE_IGNORE_ERRORS: "1"
  RUSTC_WRAPPER: "sccache"

jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # Linux (musl for static linking - works on all distros)
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            suffix: ''
          # macOS (use native runners to avoid cross-compilation issues)
          - os: macos-15-intel
            target: x86_64-apple-darwin
            suffix: ''
          - os: macos-latest
            target: aarch64-apple-darwin
            suffix: ''
          # Windows
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            suffix: .exe

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9
        continue-on-error: true

      - name: Verify sccache or disable
        id: sccache-check
        shell: bash
        run: |
          if sccache --version 2>/dev/null && sccache --start-server 2>/dev/null; then
            echo "sccache_works=true" >> $GITHUB_OUTPUT
          else
            echo "sccache_works=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ sccache unavailable, building without cache"
          fi

      - name: Install musl-tools (Linux)
        if: contains(matrix.target, 'musl')
        run: sudo apt-get update && sudo apt-get install -y musl-tools

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.target }}-cargo-

      - name: Build release binaries
        run: cargo build --release --target ${{ matrix.target }} --package relay-client
        env:
          RUSTC_WRAPPER: ${{ steps.sccache-check.outputs.sccache_works == 'true' && 'sccache' || '' }}

      - name: Get version from Cargo.toml
        id: version
        shell: bash
        run: |
          VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "version=v$VERSION" >> $GITHUB_OUTPUT

      - name: Create release archive
        shell: bash
        run: |
          VERSION=${{ steps.version.outputs.version }}
          mkdir -p release
          
          # Client only (server is deployed to Fly.io)
          cp target/${{ matrix.target }}/release/oxidize-client${{ matrix.suffix }} release/
          
          # Create archives
          cd release
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            7z a ../oxidize-client-$VERSION-${{ matrix.target }}.zip *
          else
            tar czf ../oxidize-client-$VERSION-${{ matrix.target }}.tar.gz *
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: oxidize-client-${{ steps.version.outputs.version }}-${{ matrix.target }}
          path: |
            *.tar.gz
            *.zip

  build-desktop:
    name: Build Desktop App (${{ matrix.platform }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux
          - os: ubuntu-22.04
            platform: linux-x86_64
            target: x86_64-unknown-linux-gnu
          # macOS Intel (use native runner)
          - os: macos-15-intel
            platform: macos-x86_64
            target: x86_64-apple-darwin
          # macOS Apple Silicon (use latest ARM64 runner)
          - os: macos-latest
            platform: macos-aarch64
            target: aarch64-apple-darwin
          # Windows
          - os: windows-latest
            platform: windows-x86_64
            target: x86_64-pc-windows-msvc

    steps:
      - name: Free disk space (Linux)
        if: matrix.os == 'ubuntu-22.04'
        run: |
          echo "Before cleanup:"
          df -h /
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache
          sudo rm -rf /usr/local/share/boost /usr/share/swift /usr/local/.ghcup
          sudo rm -rf /usr/share/miniconda /usr/local/graalvm /usr/local/share/powershell
          sudo docker image prune --all --force || true
          sudo apt-get clean || true
          echo "After cleanup:"
          df -h /

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9
        continue-on-error: true

      - name: Verify sccache or disable
        id: sccache-check
        shell: bash
        run: |
          if sccache --version 2>/dev/null && sccache --start-server 2>/dev/null; then
            echo "sccache_works=true" >> $GITHUB_OUTPUT
          else
            echo "sccache_works=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ sccache unavailable, building without cache"
          fi

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install Linux dependencies
        if: matrix.os == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libglib2.0-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf rpm

      - name: Install macOS dependencies
        if: startsWith(matrix.os, 'macos')
        run: brew install create-dmg

      - name: Download WinDivert (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $WinDivertVersion = "2.2.2"
          $WinDivertUrl = "https://github.com/basil00/WinDivert/releases/download/v$WinDivertVersion/WinDivert-$WinDivertVersion-A.zip"
          $WinDivertZip = "$env:TEMP\WinDivert.zip"
          $WinDivertDir = "app/src-tauri/WinDivert"
          
          Write-Host "Downloading WinDivert v$WinDivertVersion..."
          Invoke-WebRequest -Uri $WinDivertUrl -OutFile $WinDivertZip -UseBasicParsing
          
          Write-Host "Extracting WinDivert..."
          Expand-Archive -Path $WinDivertZip -DestinationPath "$env:TEMP\WinDivert" -Force
          
          # Create target directory and copy x64 files
          New-Item -ItemType Directory -Path $WinDivertDir -Force | Out-Null
          Copy-Item -Path "$env:TEMP\WinDivert\WinDivert-$WinDivertVersion-A\x64\*" -Destination $WinDivertDir -Force -Recurse
          
          Write-Host "WinDivert files:"
          Get-ChildItem $WinDivertDir
          
          # Cleanup
          Remove-Item -Path $WinDivertZip -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:TEMP\WinDivert" -Recurse -Force -ErrorAction SilentlyContinue

      - name: Create empty WinDivert placeholder (non-Windows)
        if: matrix.os != 'windows-latest'
        run: |
          mkdir -p app/src-tauri/WinDivert
          touch app/src-tauri/WinDivert/.gitkeep
          echo "Placeholder for non-Windows builds"

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-${{ matrix.target }}-desktop-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.target }}-desktop-cargo-

      - name: Install frontend dependencies
        working-directory: app
        shell: bash
        run: |
          bun install
          # Bun doesn't handle optional deps correctly - install platform-specific bindings
          if [[ "${{ runner.os }}" == "Linux" ]]; then
            bun add -d @tauri-apps/cli-linux-x64-gnu @rollup/rollup-linux-x64-gnu
          elif [[ "${{ runner.os }}" == "macOS" ]]; then
            bun add -d @tauri-apps/cli-darwin-arm64 @tauri-apps/cli-darwin-x64 @rollup/rollup-darwin-arm64 @rollup/rollup-darwin-x64
          elif [[ "${{ runner.os }}" == "Windows" ]]; then
            bun add -d @tauri-apps/cli-win32-x64-msvc @rollup/rollup-win32-x64-msvc
          fi

      - name: Sync version from Cargo.toml
        shell: bash
        run: |
          VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "Syncing version $VERSION to tauri.conf.json"
          sed -i.bak "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" app/src-tauri/tauri.conf.json
          rm -f app/src-tauri/tauri.conf.json.bak

      - name: Build oxidize-daemon
        shell: bash
        run: |
          cargo build --release --target ${{ matrix.target }} --package oxidize-daemon
          mkdir -p target/release
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            cp target/${{ matrix.target }}/release/oxidize-daemon.exe target/release/oxidize-daemon.exe
          else
            cp target/${{ matrix.target }}/release/oxidize-daemon target/release/oxidize-daemon
          fi
        env:
          RUSTC_WRAPPER: ${{ steps.sccache-check.outputs.sccache_works == 'true' && 'sccache' || '' }}

      - name: Get version from tauri.conf.json
        id: version
        shell: bash
        run: |
          VERSION=$(grep '"version"' app/src-tauri/tauri.conf.json | head -1 | sed 's/.*"\([0-9]*\.[0-9]*\.[0-9]*\)".*/\1/')
          echo "version=v$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Desktop app version: v$VERSION"

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RUSTC_WRAPPER: ${{ steps.sccache-check.outputs.sccache_works == 'true' && 'sccache' || '' }}
        with:
          projectPath: app
          args: --target ${{ matrix.target }} ${{ matrix.os == 'ubuntu-22.04' && '--bundles deb,rpm,appimage' || (matrix.os == 'windows-latest' && '--bundles nsis,msi' || '--bundles dmg') }}

      - name: List bundle outputs (debug)
        shell: bash
        run: |
          echo "=== Bundle directory contents ==="
          find target/${{ matrix.target }}/release/bundle -type f 2>/dev/null || echo "No bundle directory found"

      - name: Prepare release artifacts (Linux)
        if: matrix.os == 'ubuntu-22.04'
        shell: bash
        run: |
          VERSION=${{ steps.version.outputs.version }}
          mkdir -p desktop-release
          
          # Copy deb
          if ls target/${{ matrix.target }}/release/bundle/deb/*.deb 1>/dev/null 2>&1; then
            cp target/${{ matrix.target }}/release/bundle/deb/*.deb desktop-release/oxidize-desktop-$VERSION-${{ matrix.platform }}.deb
            echo "âœ… Copied .deb"
          else
            echo "âš ï¸ No .deb found"
          fi
          
          # Copy AppImage
          if ls target/${{ matrix.target }}/release/bundle/appimage/*.AppImage 1>/dev/null 2>&1; then
            cp target/${{ matrix.target }}/release/bundle/appimage/*.AppImage desktop-release/oxidize-desktop-$VERSION-${{ matrix.platform }}.AppImage
            echo "âœ… Copied .AppImage"
          else
            echo "âš ï¸ No .AppImage found"
          fi
          
          # Copy rpm
          if ls target/${{ matrix.target }}/release/bundle/rpm/*.rpm 1>/dev/null 2>&1; then
            cp target/${{ matrix.target }}/release/bundle/rpm/*.rpm desktop-release/oxidize-desktop-$VERSION-${{ matrix.platform }}.rpm
            echo "âœ… Copied .rpm"
          else
            echo "âš ï¸ No .rpm found"
          fi
          
          echo "=== desktop-release contents ==="
          ls -la desktop-release/

      - name: Prepare release artifacts (macOS)
        if: startsWith(matrix.os, 'macos')
        shell: bash
        run: |
          VERSION=${{ steps.version.outputs.version }}
          mkdir -p desktop-release
          
          if ls target/${{ matrix.target }}/release/bundle/dmg/*.dmg 1>/dev/null 2>&1; then
            cp target/${{ matrix.target }}/release/bundle/dmg/*.dmg desktop-release/oxidize-desktop-$VERSION-${{ matrix.platform }}.dmg
            echo "âœ… Copied .dmg"
          else
            echo "âš ï¸ No .dmg found"
          fi
          
          echo "=== desktop-release contents ==="
          ls -la desktop-release/

      - name: Prepare release artifacts (Windows)
        if: matrix.os == 'windows-latest'
        shell: bash
        run: |
          VERSION=${{ steps.version.outputs.version }}
          mkdir -p desktop-release
          
          # Copy MSI
          if ls target/${{ matrix.target }}/release/bundle/msi/*.msi 1>/dev/null 2>&1; then
            cp target/${{ matrix.target }}/release/bundle/msi/*.msi desktop-release/oxidize-desktop-$VERSION-${{ matrix.platform }}.msi
            echo "âœ… Copied .msi"
          else
            echo "âš ï¸ No .msi found"
          fi
          
          # Copy NSIS installer
          if ls target/${{ matrix.target }}/release/bundle/nsis/*.exe 1>/dev/null 2>&1; then
            cp target/${{ matrix.target }}/release/bundle/nsis/*.exe desktop-release/oxidize-desktop-$VERSION-${{ matrix.platform }}-setup.exe
            echo "âœ… Copied NSIS .exe"
          else
            echo "âš ï¸ No NSIS .exe found"
          fi
          
          echo "=== desktop-release contents ==="
          ls -la desktop-release/

      - name: Upload desktop artifacts
        uses: actions/upload-artifact@v4
        with:
          name: oxidize-desktop-${{ steps.version.outputs.version }}-${{ matrix.platform }}
          path: desktop-release/*
          if-no-files-found: warn

  release:
    name: Create Release
    needs: [build, build-desktop]
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.check_tag.outputs.should_release == 'true' }}
      tag: ${{ steps.check_tag.outputs.tag }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from Cargo.toml
        id: get_version
        run: |
          VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "version=v$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Version from Cargo.toml: v$VERSION"

      - name: Check if tag exists
        id: check_tag
        run: |
          TAG=${{ steps.get_version.outputs.version }}
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG"; then
            echo "tag=$TAG" >> $GITHUB_OUTPUT
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ Tag $TAG already exists, skipping release"
          else
            echo "tag=$TAG" >> $GITHUB_OUTPUT
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "ðŸš€ Tag $TAG does not exist, will create release"
          fi

      - name: Create and push tag
        if: steps.check_tag.outputs.should_release == 'true'
        run: |
          TAG=${{ steps.check_tag.outputs.tag }}
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"
          echo "âœ… Created and pushed tag: $TAG"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download all artifacts
        if: steps.check_tag.outputs.should_release == 'true'
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List downloaded artifacts (debug)
        if: steps.check_tag.outputs.should_release == 'true'
        run: |
          echo "=== All downloaded artifacts ==="
          find artifacts -type f | sort
          echo "=== Total files: $(find artifacts -type f | wc -l) ==="

      - name: Generate latest.json for Tauri updater
        if: steps.check_tag.outputs.should_release == 'true'
        run: |
          VERSION=${{ steps.get_version.outputs.version }}
          VERSION_NUM=${VERSION#v}
          REPO="gagansuie/oxidize"
          
          cat > artifacts/latest.json << EOF
          {
            "version": "$VERSION_NUM",
            "notes": "See release notes at https://github.com/$REPO/releases/tag/$VERSION",
            "pub_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "platforms": {
              "linux-x86_64": {
                "url": "https://github.com/$REPO/releases/download/$VERSION/oxidize-desktop-$VERSION-linux-x86_64.AppImage",
                "signature": ""
              },
              "darwin-x86_64": {
                "url": "https://github.com/$REPO/releases/download/$VERSION/oxidize-desktop-$VERSION-macos-x86_64.dmg",
                "signature": ""
              },
              "darwin-aarch64": {
                "url": "https://github.com/$REPO/releases/download/$VERSION/oxidize-desktop-$VERSION-macos-aarch64.dmg",
                "signature": ""
              },
              "windows-x86_64": {
                "url": "https://github.com/$REPO/releases/download/$VERSION/oxidize-desktop-$VERSION-windows-x86_64-setup.exe",
                "signature": ""
              }
            }
          }
          EOF
          echo "ðŸ“ Generated latest.json for Tauri updater"
          cat artifacts/latest.json

      - name: Create Release
        if: steps.check_tag.outputs.should_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.check_tag.outputs.tag }}
          files: artifacts/**/*
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy:
    name: Deploy to Fly.io
    needs: release
    runs-on: ubuntu-latest
    if: needs.release.outputs.release_created == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy to Fly.io
        run: flyctl deploy --remote-only --strategy bluegreen
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Verify deployment
        run: |
          sleep 10
          flyctl status
          echo "âœ… Deployed to relay.oxd.sh:4433"
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
