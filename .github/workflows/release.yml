name: Release Build

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # Linux (musl for static linking - works on all distros)
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            suffix: ''
          # macOS
          - os: macos-latest
            target: x86_64-apple-darwin
            suffix: ''
          - os: macos-latest
            target: aarch64-apple-darwin
            suffix: ''
          # Windows
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            suffix: .exe

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install musl-tools (Linux)
        if: contains(matrix.target, 'musl')
        run: sudo apt-get update && sudo apt-get install -y musl-tools

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release binaries
        run: cargo build --release --target ${{ matrix.target }} --package relay-client

      - name: Get version from Cargo.toml
        id: version
        shell: bash
        run: |
          VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "version=v$VERSION" >> $GITHUB_OUTPUT

      - name: Create release archive
        shell: bash
        run: |
          VERSION=${{ steps.version.outputs.version }}
          mkdir -p release
          
          # Client only (server is deployed to Fly.io)
          cp target/${{ matrix.target }}/release/oxidize-client${{ matrix.suffix }} release/
          
          # Create archives
          cd release
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            7z a ../oxidize-client-$VERSION-${{ matrix.target }}.zip *
          else
            tar czf ../oxidize-client-$VERSION-${{ matrix.target }}.tar.gz *
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: oxidize-client-${{ steps.version.outputs.version }}-${{ matrix.target }}
          path: |
            *.tar.gz
            *.zip

  build-desktop:
    name: Build Desktop App (${{ matrix.platform }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux
          - os: ubuntu-22.04
            platform: linux-x86_64
            target: x86_64-unknown-linux-gnu
          # macOS Intel
          - os: macos-latest
            platform: macos-x86_64
            target: x86_64-apple-darwin
          # macOS Apple Silicon
          - os: macos-latest
            platform: macos-aarch64
            target: aarch64-apple-darwin
          # Windows
          - os: windows-latest
            platform: windows-x86_64
            target: x86_64-pc-windows-msvc

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install Linux dependencies
        if: matrix.os == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libglib2.0-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install macOS dependencies
        if: startsWith(matrix.os, 'macos')
        run: brew install create-dmg

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-${{ matrix.target }}-desktop-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install frontend dependencies
        working-directory: app
        run: bun install --frozen-lockfile

      - name: Sync version from Cargo.toml
        shell: bash
        run: |
          VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "Syncing version $VERSION to tauri.conf.json"
          sed -i.bak "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" app/src-tauri/tauri.conf.json
          rm -f app/src-tauri/tauri.conf.json.bak

      - name: Build oxidize-daemon (Linux)
        if: matrix.os == 'ubuntu-22.04'
        run: |
          cargo build --release --target ${{ matrix.target }} --package oxidize-daemon
          # Copy to expected path for Tauri bundling
          mkdir -p target/release
          cp target/${{ matrix.target }}/release/oxidize-daemon target/release/oxidize-daemon

      - name: Build oxidize-daemon (macOS)
        if: startsWith(matrix.os, 'macos')
        run: |
          cargo build --release --target ${{ matrix.target }} --package oxidize-daemon
          # Copy to expected path for Tauri bundling
          mkdir -p target/release
          cp target/${{ matrix.target }}/release/oxidize-daemon target/release/oxidize-daemon

      - name: Build oxidize-daemon (Windows)
        if: matrix.os == 'windows-latest'
        shell: bash
        run: |
          cargo build --release --target ${{ matrix.target }} --package oxidize-daemon
          # Copy to expected path for Tauri bundling
          mkdir -p target/release
          cp target/${{ matrix.target }}/release/oxidize-daemon.exe target/release/oxidize-daemon.exe

      - name: Get version from tauri.conf.json
        id: version
        shell: bash
        run: |
          VERSION=$(grep '"version"' app/src-tauri/tauri.conf.json | head -1 | sed 's/.*"\([0-9]*\.[0-9]*\.[0-9]*\)".*/\1/')
          echo "version=v$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Desktop app version: v$VERSION"

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: app
          args: --target ${{ matrix.target }}

      - name: Prepare release artifacts (Linux)
        if: matrix.os == 'ubuntu-22.04'
        shell: bash
        run: |
          VERSION=${{ steps.version.outputs.version }}
          mkdir -p desktop-release
          cp target/${{ matrix.target }}/release/bundle/deb/*.deb desktop-release/oxidize-desktop-$VERSION-${{ matrix.platform }}.deb || true
          cp target/${{ matrix.target }}/release/bundle/appimage/*.AppImage desktop-release/oxidize-desktop-$VERSION-${{ matrix.platform }}.AppImage || true
          cp target/${{ matrix.target }}/release/bundle/rpm/*.rpm desktop-release/oxidize-desktop-$VERSION-${{ matrix.platform }}.rpm || true

      - name: Prepare release artifacts (macOS)
        if: startsWith(matrix.os, 'macos')
        shell: bash
        run: |
          VERSION=${{ steps.version.outputs.version }}
          mkdir -p desktop-release
          cp target/${{ matrix.target }}/release/bundle/dmg/*.dmg desktop-release/oxidize-desktop-$VERSION-${{ matrix.platform }}.dmg || true

      - name: Prepare release artifacts (Windows)
        if: matrix.os == 'windows-latest'
        shell: bash
        run: |
          VERSION=${{ steps.version.outputs.version }}
          mkdir -p desktop-release
          cp target/${{ matrix.target }}/release/bundle/msi/*.msi desktop-release/oxidize-desktop-$VERSION-${{ matrix.platform }}.msi || true
          cp target/${{ matrix.target }}/release/bundle/nsis/*.exe desktop-release/oxidize-desktop-$VERSION-${{ matrix.platform }}-setup.exe || true

      - name: Upload desktop artifacts
        uses: actions/upload-artifact@v4
        with:
          name: oxidize-desktop-${{ steps.version.outputs.version }}-${{ matrix.platform }}
          path: desktop-release/*

  release:
    name: Create Release
    needs: [build, build-desktop]
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.check_tag.outputs.should_release == 'true' }}
      tag: ${{ steps.check_tag.outputs.tag }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from Cargo.toml
        id: get_version
        run: |
          VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "version=v$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Version from Cargo.toml: v$VERSION"

      - name: Check if tag exists
        id: check_tag
        run: |
          TAG=${{ steps.get_version.outputs.version }}
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG"; then
            echo "tag=$TAG" >> $GITHUB_OUTPUT
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ Tag $TAG already exists, skipping release"
          else
            echo "tag=$TAG" >> $GITHUB_OUTPUT
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "ðŸš€ Tag $TAG does not exist, will create release"
          fi

      - name: Create and push tag
        if: steps.check_tag.outputs.should_release == 'true'
        run: |
          TAG=${{ steps.check_tag.outputs.tag }}
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"
          echo "âœ… Created and pushed tag: $TAG"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download all artifacts
        if: steps.check_tag.outputs.should_release == 'true'
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        if: steps.check_tag.outputs.should_release == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.check_tag.outputs.tag }}
          files: artifacts/**/*
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy:
    name: Deploy to Fly.io
    needs: release
    runs-on: ubuntu-latest
    if: needs.release.outputs.release_created == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy to Fly.io
        run: flyctl deploy --remote-only --strategy bluegreen
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Verify deployment
        run: |
          sleep 10
          flyctl status
          echo "âœ… Deployed to relay.oxd.sh:4433"
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
