name: Release Build

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  SCCACHE_GHA_ENABLED: "true"
  SCCACHE_IGNORE_ERRORS: "1"
  RUSTC_WRAPPER: "sccache"

jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # Linux (musl for static linking - works on all distros)
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            suffix: ''
          # macOS (use native runners to avoid cross-compilation issues)
          - os: macos-15-intel
            target: x86_64-apple-darwin
            suffix: ''
          - os: macos-latest
            target: aarch64-apple-darwin
            suffix: ''
          # Windows
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            suffix: .exe

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust environment
        id: setup-rust
        uses: ./.github/actions/setup-rust
        with:
          target: ${{ matrix.target }}
          cache-prefix: cli

      - name: Install musl-tools (Linux)
        if: contains(matrix.target, 'musl')
        run: |
          # Remove problematic Microsoft repos that return 403 Forbidden
          sudo rm -f /etc/apt/sources.list.d/microsoft-prod.list /etc/apt/sources.list.d/azure-cli.list 2>/dev/null || true
          sudo apt-get update && sudo apt-get install -y musl-tools

      - name: Clean main binaries (force version rebuild)
        shell: bash
        run: |
          # Remove only the main binaries to force rebuild with correct version
          # Dependencies stay cached
          rm -f target/${{ matrix.target }}/release/oxidize-* 2>/dev/null || true
          rm -f target/${{ matrix.target }}/release/relay-* 2>/dev/null || true

      - name: Build release binaries
        run: cargo build --release --target ${{ matrix.target }} --package relay-client --package oxidize-daemon
        env:
          RUSTC_WRAPPER: ${{ steps.setup-rust.outputs.sccache-enabled == 'true' && 'sccache' || '' }}

      - name: Get version
        id: version
        uses: ./.github/actions/get-version

      - name: Create release archive
        shell: bash
        run: |
          VERSION=${{ steps.version.outputs.version }}
          mkdir -p release
          
          # Client and daemon binaries
          cp target/${{ matrix.target }}/release/oxidize-client${{ matrix.suffix }} release/
          cp target/${{ matrix.target }}/release/oxidize-daemon${{ matrix.suffix }} release/
          
          # Create archives
          cd release
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            7z a ../oxidize-client-$VERSION-${{ matrix.target }}.zip *
          else
            tar czf ../oxidize-client-$VERSION-${{ matrix.target }}.tar.gz *
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: oxidize-client-${{ steps.version.outputs.version }}-${{ matrix.target }}
          path: |
            *.tar.gz
            *.zip

  build-desktop:
    name: Build Desktop App (${{ matrix.platform }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux
          - os: ubuntu-22.04
            platform: linux-x86_64
            target: x86_64-unknown-linux-gnu
          # macOS Intel (use native runner)
          - os: macos-15-intel
            platform: macos-x86_64
            target: x86_64-apple-darwin
          # macOS Apple Silicon (use latest ARM64 runner)
          - os: macos-latest
            platform: macos-aarch64
            target: aarch64-apple-darwin
          # Windows
          - os: windows-latest
            platform: windows-x86_64
            target: x86_64-pc-windows-msvc

    steps:
      - name: Free disk space (Linux)
        if: matrix.os == 'ubuntu-22.04'
        run: |
          echo "Before cleanup:"
          df -h /
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache
          sudo rm -rf /usr/local/share/boost /usr/share/swift /usr/local/.ghcup
          sudo rm -rf /usr/share/miniconda /usr/local/graalvm /usr/local/share/powershell
          sudo docker image prune --all --force || true
          sudo apt-get clean || true
          echo "After cleanup:"
          df -h /

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust environment
        id: setup-rust
        uses: ./.github/actions/setup-rust
        with:
          target: ${{ matrix.target }}
          cache-prefix: desktop

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install Linux dependencies
        if: matrix.os == 'ubuntu-22.04'
        run: |
          # Remove problematic Microsoft repos that return 403 Forbidden
          sudo rm -f /etc/apt/sources.list.d/microsoft-prod.list /etc/apt/sources.list.d/azure-cli.list 2>/dev/null || true
          sudo apt-get update
          sudo apt-get install -y libglib2.0-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf rpm

      - name: Install macOS dependencies
        if: startsWith(matrix.os, 'macos')
        run: brew install create-dmg

      - name: Clean main binaries (force version rebuild)
        shell: bash
        run: |
          # Remove binaries, bundles, and Tauri build artifacts (contains embedded frontend)
          # Dependencies stay cached
          rm -f target/${{ matrix.target }}/release/oxidize-* 2>/dev/null || true
          rm -rf target/${{ matrix.target }}/release/bundle 2>/dev/null || true
          rm -rf target/${{ matrix.target }}/release/build/oxidize-app-* 2>/dev/null || true

      - name: Install frontend dependencies
        working-directory: app
        shell: bash
        run: |
          bun install
          # Bun doesn't handle optional deps correctly - install platform-specific bindings
          if [[ "${{ runner.os }}" == "Linux" ]]; then
            bun add -d @tauri-apps/cli-linux-x64-gnu @rollup/rollup-linux-x64-gnu
          elif [[ "${{ runner.os }}" == "macOS" ]]; then
            bun add -d @tauri-apps/cli-darwin-arm64 @tauri-apps/cli-darwin-x64 @rollup/rollup-darwin-arm64 @rollup/rollup-darwin-x64
          elif [[ "${{ runner.os }}" == "Windows" ]]; then
            bun add -d @tauri-apps/cli-win32-x64-msvc @rollup/rollup-win32-x64-msvc
          fi

      - name: Sync version from Cargo.toml
        shell: bash
        run: |
          VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "Syncing version $VERSION to tauri.conf.json"
          sed -i.bak "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" app/src-tauri/tauri.conf.json
          rm -f app/src-tauri/tauri.conf.json.bak

      - name: Build oxidize-daemon
        shell: bash
        run: |
          cargo build --release --target ${{ matrix.target }} --package oxidize-daemon
          
          # Copy to Tauri sidecar location (binaries/oxidize-daemon-{target-triple})
          mkdir -p app/src-tauri/binaries
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            cp target/${{ matrix.target }}/release/oxidize-daemon.exe app/src-tauri/binaries/oxidize-daemon-${{ matrix.target }}.exe
            # Also copy without target triple for NSIS hooks
            cp target/${{ matrix.target }}/release/oxidize-daemon.exe app/src-tauri/binaries/oxidize-daemon.exe
          else
            cp target/${{ matrix.target }}/release/oxidize-daemon app/src-tauri/binaries/oxidize-daemon-${{ matrix.target }}
          fi
          echo "‚úÖ Daemon binary copied to sidecar location for ${{ matrix.target }}"
        env:
          RUSTC_WRAPPER: ${{ steps.setup-rust.outputs.sccache-enabled == 'true' && 'sccache' || '' }}

      - name: Get version
        id: version
        uses: ./.github/actions/get-version

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RUSTC_WRAPPER: ${{ steps.setup-rust.outputs.sccache-enabled == 'true' && 'sccache' || '' }}
        with:
          projectPath: app
          args: --target ${{ matrix.target }} ${{ matrix.os == 'ubuntu-22.04' && '--bundles deb,rpm,appimage' || (matrix.os == 'windows-latest' && '--bundles nsis,msi' || '--bundles dmg') }}

      - name: List bundle outputs (debug)
        shell: bash
        run: |
          echo "=== Bundle directory contents ==="
          find target/${{ matrix.target }}/release/bundle -type f 2>/dev/null || echo "No bundle directory found"

      - name: Prepare release artifacts
        shell: bash
        run: |
          VERSION=${{ steps.version.outputs.version }}
          mkdir -p desktop-release
          BUNDLE=target/${{ matrix.target }}/release/bundle
          
          # Helper to copy first matching file
          copy_first() {
            local pattern="$1" dest="$2"
            for f in $pattern; do
              [ -f "$f" ] && cp "$f" "$dest" && echo "‚úÖ Copied $(basename $dest)" && return 0
            done
            echo "‚ö†Ô∏è No $(basename $dest) found"
          }
          
          # Linux artifacts
          if [[ "${{ matrix.os }}" == "ubuntu-22.04" ]]; then
            copy_first "$BUNDLE/deb/*.deb" "desktop-release/oxidize-desktop-$VERSION-${{ matrix.platform }}.deb"
            copy_first "$BUNDLE/appimage/*.AppImage" "desktop-release/oxidize-desktop-$VERSION-${{ matrix.platform }}.AppImage"
            copy_first "$BUNDLE/rpm/*.rpm" "desktop-release/oxidize-desktop-$VERSION-${{ matrix.platform }}.rpm"
          # macOS artifacts
          elif [[ "${{ matrix.os }}" == macos* ]]; then
            copy_first "$BUNDLE/dmg/*.dmg" "desktop-release/oxidize-desktop-$VERSION-${{ matrix.platform }}.dmg"
          # Windows artifacts
          elif [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            copy_first "$BUNDLE/msi/*.msi" "desktop-release/oxidize-desktop-$VERSION-${{ matrix.platform }}.msi"
            copy_first "$BUNDLE/nsis/*.exe" "desktop-release/oxidize-desktop-$VERSION-${{ matrix.platform }}-setup.exe"
          fi
          
          echo "=== desktop-release contents ==="
          ls -la desktop-release/

      - name: Upload desktop artifacts
        uses: actions/upload-artifact@v4
        with:
          name: oxidize-desktop-${{ steps.version.outputs.version }}-${{ matrix.platform }}
          path: desktop-release/*
          if-no-files-found: warn

  release:
    name: Create Release
    needs: [build, build-desktop]
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.check_tag.outputs.should_release == 'true' }}
      tag: ${{ steps.check_tag.outputs.tag }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: get_version
        uses: ./.github/actions/get-version

      - name: Check if tag exists
        id: check_tag
        run: |
          TAG=${{ steps.get_version.outputs.version }}
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG"; then
            echo "tag=$TAG" >> $GITHUB_OUTPUT
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è Tag $TAG already exists, skipping release"
          else
            echo "tag=$TAG" >> $GITHUB_OUTPUT
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "üöÄ Tag $TAG does not exist, will create release"
          fi

      - name: Create and push tag
        if: steps.check_tag.outputs.should_release == 'true'
        run: |
          TAG=${{ steps.check_tag.outputs.tag }}
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"
          echo "‚úÖ Created and pushed tag: $TAG"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download all artifacts
        if: steps.check_tag.outputs.should_release == 'true'
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List downloaded artifacts (debug)
        if: steps.check_tag.outputs.should_release == 'true'
        run: |
          echo "=== All downloaded artifacts ==="
          find artifacts -type f | sort
          echo "=== Total files: $(find artifacts -type f | wc -l) ==="

      - name: Generate latest.json for Tauri updater
        if: steps.check_tag.outputs.should_release == 'true'
        run: |
          VERSION=${{ steps.get_version.outputs.version }}
          VERSION_NUM=${VERSION#v}
          REPO="gagansuie/oxidize"
          
          cat > artifacts/latest.json << EOF
          {
            "version": "$VERSION_NUM",
            "notes": "See release notes at https://github.com/$REPO/releases/tag/$VERSION",
            "pub_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "platforms": {
              "linux-x86_64": {
                "url": "https://github.com/$REPO/releases/download/$VERSION/oxidize-desktop-$VERSION-linux-x86_64.AppImage",
                "signature": ""
              },
              "darwin-x86_64": {
                "url": "https://github.com/$REPO/releases/download/$VERSION/oxidize-desktop-$VERSION-macos-x86_64.dmg",
                "signature": ""
              },
              "darwin-aarch64": {
                "url": "https://github.com/$REPO/releases/download/$VERSION/oxidize-desktop-$VERSION-macos-aarch64.dmg",
                "signature": ""
              },
              "windows-x86_64": {
                "url": "https://github.com/$REPO/releases/download/$VERSION/oxidize-desktop-$VERSION-windows-x86_64-setup.exe",
                "signature": ""
              }
            }
          }
          EOF
          echo "üìù Generated latest.json for Tauri updater"
          cat artifacts/latest.json

      - name: Create Release
        if: steps.check_tag.outputs.should_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.check_tag.outputs.tag }}
          files: artifacts/**/*
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-latitude:
    name: Deploy to Latitude.sh Bare Metal
    needs: release
    runs-on: ubuntu-latest
    if: needs.release.outputs.release_created == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust environment
        id: setup-rust
        uses: ./.github/actions/setup-rust
        with:
          target: x86_64-unknown-linux-gnu
          cache-prefix: latitude-server

      - name: Build server binary
        run: |
          RUSTFLAGS="-C target-cpu=x86-64-v3" cargo build --release -p relay-server
          strip target/release/oxidize-server
        env:
          RUSTC_WRAPPER: ${{ steps.setup-rust.outputs.sccache-enabled == 'true' && 'sccache' || '' }}

      - name: Deploy to Latitude.sh
        env:
          LATITUDE_API_TOKEN: ${{ secrets.LATITUDE_API_TOKEN }}
          LATITUDE_SSH_KEY: ${{ secrets.LATITUDE_SSH_KEY }}
          LATITUDE_PROJECT_ID: ${{ secrets.LATITUDE_PROJECT_ID }}
        run: |
          # Skip if secrets not configured
          if [[ -z "$LATITUDE_API_TOKEN" ]] || [[ -z "$LATITUDE_SSH_KEY" ]]; then
            echo "‚è≠Ô∏è Latitude.sh not configured, skipping"
            exit 0
          fi
          
          # Fetch server IPs from Latitude.sh API
          echo "‚Üí Fetching servers from Latitude.sh API..."
          SERVERS_JSON=$(curl -s -H "Authorization: Bearer $LATITUDE_API_TOKEN" \
            "https://api.latitude.sh/servers?filter[project]=${LATITUDE_PROJECT_ID:-}")
          
          # Extract running server IPs
          LATITUDE_HOST=$(echo "$SERVERS_JSON" | jq -r '.data[] | select(.attributes.status == "on") | .attributes.primary_ipv4' | head -1)
          
          if [[ -z "$LATITUDE_HOST" ]] || [[ "$LATITUDE_HOST" == "null" ]]; then
            echo "‚ùå No running Latitude.sh servers found"
            exit 1
          fi
          
          echo "‚Üí Found server: $LATITUDE_HOST"
          
          # Setup SSH
          mkdir -p ~/.ssh
          echo "$LATITUDE_SSH_KEY" > ~/.ssh/latitude_key
          chmod 600 ~/.ssh/latitude_key
          ssh-keyscan -H $LATITUDE_HOST >> ~/.ssh/known_hosts 2>/dev/null || true
          
          echo "‚Üí Deploying to Latitude.sh ($LATITUDE_HOST)..."
          
          # Upload binary
          scp -i ~/.ssh/latitude_key -o StrictHostKeyChecking=no \
              target/release/oxidize-server \
              ubuntu@$LATITUDE_HOST:/tmp/oxidize-server
          
          # Zero-downtime deploy with systemd + DPDK
          ssh -i ~/.ssh/latitude_key -o StrictHostKeyChecking=no ubuntu@$LATITUDE_HOST << 'REMOTE'
            set -e
            BINARY=/tmp/oxidize-server
            INSTALL=/opt/oxidize/oxidize-server
            BACKUP_DIR=/opt/oxidize/backup
            SERVICE=oxidize
            CONFIG_DIR=/etc/oxidize
            
            # Create directories
            sudo mkdir -p /opt/oxidize $BACKUP_DIR
            
            # Backup current binary
            [[ -f $INSTALL ]] && sudo cp $INSTALL $BACKUP_DIR/oxidize-server.$(date +%s)
            
            # Keep only last 3 backups
            sudo ls -t $BACKUP_DIR/oxidize-server.* 2>/dev/null | tail -n +4 | sudo xargs rm -f 2>/dev/null || true
            
            # Stop service gracefully
            if systemctl is-active --quiet $SERVICE 2>/dev/null; then
              sudo systemctl stop $SERVICE
              echo "‚Üí Stopped $SERVICE service"
            fi
            
            # Atomic swap
            sudo chmod +x $BINARY
            sudo mv $BINARY $INSTALL
            
            # Ensure DPDK is set up (idempotent)
            if command -v dpdk-devbind.py &> /dev/null; then
              echo "‚Üí Checking DPDK binding..."
              if [[ -f "$CONFIG_DIR/nic-config.env" ]]; then
                source "$CONFIG_DIR/nic-config.env"
                DATA_PCI=$(ethtool -i "$DATA_NIC" 2>/dev/null | grep "bus-info" | awk '{print $2}' || true)
                if [[ -n "$DATA_PCI" ]] && ! dpdk-devbind.py --status-dev net | grep -q "$DATA_PCI.*drv=vfio-pci"; then
                  echo "‚Üí Binding $DATA_NIC to DPDK..."
                  sudo modprobe vfio-pci
                  echo 1 | sudo tee /sys/module/vfio/parameters/enable_unsafe_noiommu_mode > /dev/null 2>&1 || true
                  sudo ip link set "$DATA_NIC" down 2>/dev/null || true
                  sudo dpdk-devbind.py -b vfio-pci "$DATA_PCI" 2>/dev/null || echo "DPDK bind skipped"
                fi
              fi
            fi
            
            # Start via systemd
            sudo systemctl start $SERVICE
            
            # Health check with retry
            for i in 1 2 3 4 5; do
              sleep 2
              if systemctl is-active --quiet $SERVICE && sudo ss -ulnp | grep -q ':4433'; then
                echo "‚úì Service running and listening on port 4433"
                exit 0
              fi
              echo "Retry $i..."
            done
            
            # Rollback on failure
            echo "‚ùå Health check failed, rolling back..."
            sudo journalctl -u $SERVICE -n 20 --no-pager || true
            LATEST_BACKUP=$(sudo ls -t $BACKUP_DIR/oxidize-server.* 2>/dev/null | head -1)
            if [[ -f "$LATEST_BACKUP" ]]; then
              sudo cp "$LATEST_BACKUP" $INSTALL
              sudo systemctl start $SERVICE
              echo "‚Ü©Ô∏è Rolled back to previous version"
            fi
            exit 1
          REMOTE
          
          echo "‚úÖ Deployed to Latitude.sh"
          rm -f ~/.ssh/latitude_key
